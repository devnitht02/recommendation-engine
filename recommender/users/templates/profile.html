{% extends "base.html" %}
{% load static %}

{% block css_cdn %}
    {#    <link rel="stylesheet" href="{% src 'profile.css' %}">#}
{% endblock css_cdn %}

{% block content %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <div class="max-w-4xl mx-auto bg-white p-8 shadow-md rounded-lg border mt-10" style="margin-top: 8rem">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">My Profile</h2>

        <script>
            document.getElementById('profile_picture').addEventListener('change', function (e) {
                const [file] = e.target.files;
                if (!file) return;

                // Show preview immediately
                const preview = document.getElementById('profile-picture-preview');
                preview.src = URL.createObjectURL(file);

                // Upload via AJAX
                const formData = new FormData();
                formData.append('profile_picture', file);

                fetch("{% url 'users:upload_profile_picture' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === "success") {
                            console.log("Profile photo updated!");
                        } else {
                            alert("Upload failed: " + data.message);
                        }
                    })
                    .catch(err => {
                        console.error("AJAX error:", err);
                    });
            });
        </script>


        <!-- Profile Update Form -->
        <form method="POST" action="{% url 'users:user_profile' %}" enctype="multipart/form-data"
              class="space-y-4 bg-white"
              id="profileForm">
            {% csrf_token %}
            <!-- Profile Picture Upload Section -->
            <div class="flex items-center space-x-4 mb-6">
                <div class="relative">
                    {% if profile.profile_picture %}
                        <img id="profile-picture-preview"
                             src="{{ profile.profile_picture.url }}"
                             class="w-24 h-24 rounded-full object-cover border"
                             alt="Profile Picture"/>
                    {% else %}
                        <img id="profile-picture-preview"
                             src="{% static "/assets/images/avatar.jpg" %}"
                             class="w-24 h-24 rounded-full object-cover border"
                             alt="No Profile Picture"/>
                    {% endif %}



                    <input type="file" name="profile_picture" id="profile_picture"
                           class="absolute top-0 left-0 w-24 h-24 opacity-0 cursor-pointer"
                           accept="image/*">
                </div>

                <div>
                    <h3 class="text-xl font-medium text-gray-900">{{ profile.user_name }}</h3>
                    <p class="text-gray-600">{{ profile.email }}</p>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" name="email" value="{{ profile.email }}" readonly
                       class="w-full p-2 border border-gray-300 rounded-md bg-gray-100">
            </div>


            <div>
                <label class="block text-sm font-medium text-gray-700">Date of Birth</label>
                <input type="date" name="date_of_birth" value="{{ profile.date_of_birth|date:'Y-m-d' }}"
                       class="w-full p-2 border border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Gender</label>
                <select name="user_gender" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="" {% if not profile.user_gender %}selected{% endif %}>Select</option>
                    <option value="male" {% if profile.user_gender == "male" %}selected{% endif %}>Male</option>
                    <option value="female" {% if profile.user_gender == "female" %}selected{% endif %}>Female</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Stream</label>
                <select name="stream" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="">Select a stream</option>
                    {% for stream in streams %}
                        <option value="{{ stream.stream_name }}" {% if profile.stream == stream.stream_name %}selected{% endif %}>
                            {{ stream.stream_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>


            <div>
                <label class="block text-sm font-medium text-gray-700">Total HSC Percentage</label>
                <input type="text" name="hsc_percentage" value="{{ profile.hsc_percentage|default_if_none:'' }}"
                       class="w-full p-2 border border-gray-300 rounded-md">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">School Passing Year</label>
                <input type="text" name="school_passed_out_year"
                       value="{{ profile.school_passed_out_year|default_if_none:'' }}"
                       class="w-full p-2 border border-gray-300 rounded-md">
            </div>

            <label for="institution_type">Institution Type</label>
            <select name="institution_type" id="institution_type" required
                    class="w-full border rounded p-2">
                <option value="">Select Type</option>
                <option value="0" {% if profile.studied_institution_type == 0 %}selected{% endif %}>Public</option>
                <option value="1" {% if profile.studied_institution_type == 1 %}selected{% endif %}>Private</option>
            </select>

            <div>
                <label for="state" class="block text-sm font-medium text-gray-700">Select State:</label>
                <select id="state" name="state" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="">Select a State</option>
                    {% for state in states %}
                        <option value="{{ state.id }}" {% if state.id == profile.state %}selected{% endif %}>
                            {{ state.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label for="district" class="block text-sm font-medium text-gray-700">District:</label>
                <select id="district" name="district" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="">Select District</option>
                </select>
            </div>

            <button type="submit" id="updateProfileBtn"
                    style="background-color: #5521b5; margin-top: 3rem"
                    class="w-full text-white bg-[#CB6040] hover:bg-[#B35235] focus:ring-4 focus:outline-none focus:ring-orange-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                Update Profile
            </button>
        </form>

    </div>


    <script>
        $(document).ready(function () {
            $("#state").change(function () {
                let stateId = $(this).val();
                if (stateId) {
                    $.ajax({
                        url: "/district-list/" + stateId + "/",
                        type: "GET",
                        dataType: "json",
                        success: function (response) {
                            console.log(response);
                            let districtDropdown = $("#district");
                            districtDropdown.empty();
                            districtDropdown.append('<option value="">Select District</option>');
                            $.each(response, function (index, district) {
                                districtDropdown.append('<option value="' + district.id + '">' + district.name + '</option>');
                            });
                        }
                    });
                } else {
                    $("#district").empty().append('<option value="">Select District</option>');
                }
            });

            $("#updateProfileButton").click(function () {
                const formData = {
                    name: $("#name").val(),
                    email: $("#email").val(),
                    country: $("#country").val(),
                    dob: $("#dob").val(),
                    gender: $("#gender").val(),
                    school_year: $("#school_year").val(),
                    state_id: $("#state").val(),
                    district_id: $("#district").val(),
                    stream: $("#stream").val(),
                    hsc: $("#hsc").val(),
                    institution_type: $("#institution_type").val(),
                };

                $.ajax({
                    url: "/update_user_profile/",
                    type: "POST",
                    data: formData,
                    success: function (response) {

                        alert("Profile updated successfully!");

                        $("#name").val(response.name);
                        $("#email").val(response.email);
                        $("#country").val(response.country);
                        $("#dob").val(response.dob);
                        $("#gender").val(response.gender);
                        $("#school_year").val(response.school_year);
                        $("#state").val(response.state_id);
                        $("#district").val(response.district_id);
                        $("#stream").val(response.stream);
                        $("#hsc").val(response.hsc);
                        $("#institution_type").val(response.institution_type);
                    },
                    error: function () {
                        alert("There was an error updating the profile.");
                    }
                });
            });
        });
        document.getElementById('profile_picture').addEventListener('change', function (e) {
            const [file] = e.target.files;
            if (file) {
                const preview = document.getElementById('profile-picture-preview');
                preview.src = URL.createObjectURL(file);
            }
        });
        const btn = document.getElementById("updateProfileBtn");

        btn.addEventListener("mouseenter", function () {
            btn.style.backgroundColor = "#6B3FD9";
            btn.style.transition = "background-color 0.3s ease";
        });

        btn.addEventListener("mouseleave", function () {
            btn.style.backgroundColor = "#5521b5";
        });
    </script>


    {% include 'footer.html' %}


{% endblock %}
